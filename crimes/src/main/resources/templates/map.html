<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <!-- <meta charset="utf-8"> -->
  <meta name="viewport" content="width=device-width" initial-scale="1.0">
  <!-- <link href="style.css" rel="stylesheet" type="text/css" /> -->
  <title>TBD</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" th:href="@{/css/map.css}"/>
  <!-- fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Manrope&family=Nothing+You+Could+Do&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""/>
   <!-- Make sure you put this AFTER Leaflet's CSS -->
   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
   crossorigin=""></script>

  <!-- <script type="text/javascript" th:src="@{/js/src/landing.js}"></script> -->

</head>

<body>

    <div class="map-nav">
        <a href="/" class="home-btn">&lt; RETURN HOME</a>
        <i class='bx bxs-map-pin'></i>
        <h1>CPP Campus Crime Map</h1> 
        <div class="choose-date">
            <input type="date" id="from-date" min="2020-06-29">
            to
            <input type="date" id="to-date" max="">
        </div>
        <div class="choose-time">
            <input type="time" id="from-time">
            to
            <input type="time" id="to-time">
        </div>
        
    </div>
    
    <div class="map-container" id="map"></div>

    
    
    

<!-- <script type="text/javascript" src="\crimes"></script> -->

<script>
    // initializing map with correct location
    var northWest = L.latLng(34.070613482323076, -117.8207302093506);
    var southEast = L.latLng(34.04547673206297, -117.82583713531496);
    bounds = L.latLngBounds(northWest, southEast);
    var map = L.map('map', {
        // maxBounds: bounds,
        // minZoom: 15
    }).setView([34.05803802437078, -117.82330428528701], 15);
    // console.log(map.getBounds()); // get bounds of map

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

    function onMapClick(e) {
      alert("You clicked the map at " + e.latlng);
    }

    map.on('click', onMapClick);
    
    // getting json data from mongodb 
    var req = new XMLHttpRequest();
    req.open('GET', 'http://localhost/crimes', false); // change from localhost to domain
    req.send(null); 
    if (req.status == 200) {
        let data = req.responseText;
        const obj = JSON.parse(data);
        var arr = [];
        // console.log(obj)
        for (let i = 0; i < obj.length; i++) {
            if (obj[i].caseNumber != "Case #" && obj[i]. caseNumber != null) {
                var checkIfBuilding = obj[i].location[0].includes("Building #");
                var checkIfParkingLot = obj[i].location[0].includes("Lot");
                var checkIfVillage = obj[i].location[0].includes("University Village");
                var checkIfUniversityDrive = obj[i].location[0].includes("University Dr");
                if (obj[i].location.length > 1 ) {
                    var checkIf3530PomonaBlvd = obj[i].location[1].includes("3530 Pomona Blvd");
                }
                
                //farm store - 4102 S University Drive

                // track
                var randomizeLoc;
                var trackArr = [];
                var checkIfTrack = obj[i].location[0].includes("Track");
                if (checkIfTrack == true && checkIfBuilding == false) {
                    randomizeLoc = (Math.random() * (-0.000009 - 0.000009) + 0.00009).toFixed(5);
                    // arr.push(obj[i]);
                    var lat = parseFloat(34.052181) + parseFloat(randomizeLoc);
                    var long = parseFloat(-117.817056) + parseFloat(randomizeLoc);
                    // console.log(lat);
                    var text = obj[i].caseNumber + "<br><strong>Crime: </strong>" + obj[i].nature + "<br><strong>Occurred: </strong>" + obj[i].occurred + "<br><strong>Reported: </strong>" + obj[i].reported + " <br><strong>Location: </strong>" + obj[i].location[0] + " <br><br><strong>Disposition: </strong>" + obj[i].disposition;
                    trackArr[i] = L.marker([lat, long]).addTo(map).bindPopup(text)
                    // var marker = L.marker([lat, long]).addTo(map).bindPopup(text);
                }
                //baseball field


                //brew works - 3650

                // all locations with building numbers
                // alert(checkBuilding);
                // if (checkIfBuilding == false) {
                //     arr.push(obj[i].location);
                // }

                // unchecked ones
                if (checkIfParkingLot == false && checkIfBuilding == false && checkIfVillage == false && checkIfUniversityDrive == false && obj[i].location.length != 2 && checkIf3530PomonaBlvd == false && checkIfTrack == false) {
                    arr.push(obj[i].location);
                }
                

                // locations not already specified with only 2 elements
                // if (obj[i].location.length == 2 && checkIfParkingLot == false && checkIfBuilding == false && checkIfVillage == false) {
                //     arr.push(obj[i].location);
                // }

                // all university drive locations
                // if (checkIfUniversityDrive == true && checkIfParkingLot == false && checkIfBuilding == false && checkIfVillage == false) {
                //     arr.push(obj[i].location);
                // }

                // all university village 
                var villageArr = []
                if (checkIfVillage == true) {
                    randomizeLoc = (Math.random() * (-0.0009 - 0.001) + 0.0009).toFixed(5);
                    var lat = parseFloat(34.04123077050695) + parseFloat(randomizeLoc);
                    var long = parseFloat(-117.80990661469652) - parseFloat(randomizeLoc);
                    var text = obj[i].caseNumber + "<strong>Crime: </strong>" + obj[i].nature + "<br><strong>Occurred: </strong>" + obj[i].occurred + "<br><strong>Reported: </strong>" + obj[i].reported + " <br><strong>Location: </strong>" + obj[i].location[0] + " <br><br><strong>Disposition: </strong>" + obj[i].disposition;
                    southCampusArr[i] = L.marker([lat, long]).addTo(map).bindPopup(text);
                }
                
                //all 3530 pomona blvd locations
                var southCampusArr = []
                if (checkIf3530PomonaBlvd == true && checkIfBuilding == false) {
                    randomizeLoc = (Math.random() * (-0.00009 - 0.001) + 0.0009).toFixed(5);
                    var lat = parseFloat(34.048171) + parseFloat(randomizeLoc);
                    var long = parseFloat(-117.815035) - parseFloat(randomizeLoc);
                    var text = obj[i].caseNumber + "<strong>Crime: </strong>" + obj[i].nature + "<br><strong>Occurred: </strong>" + obj[i].occurred + "<br><strong>Reported: </strong>" + obj[i].reported + " <br><strong>Location: </strong>" + obj[i].location[0] + " <br><br><strong>Disposition: </strong>" + obj[i].disposition;
                    southCampusArr[i] = L.marker([lat, long]).addTo(map).bindPopup(text);
                }
            }
            
            // for (let i = 0; i < arr.length; i++) {
            //     console.log(arr[i]);
            // }
            // alert(arr);
        }
        console.log(arr);
        // alert(obj[1].caseNumber); // test to see if it works
        var fields = Object.keys(obj);
        // alert(fields);

    }

    // var mydata = JSON.parse();
    // alert(mydata[0].caseNumber);
    
</script>
  
</body>

</html>